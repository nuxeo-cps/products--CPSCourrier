<tal:block define="
  stack_context nocall:options/context;
  stack options/stack;
  mode options/mode;
  stack_infos python:stack.getStackContentForRender(context, mode);
  levels python:stack_infos[0];
  infos python:stack_infos[1];
  vtool stack_context/portal_vocabularies;
  vocabulary python:getattr(vtool, 'mail_directives', {});
  utool nocall:here/portal_url;
  portal portal|here/portal_url/getPortalObject;
  portal_url python:portal.absolute_url()+'/';
  ">

<tal:block condition="python:mode in ['view', 'edit']">
  <table summary="stack content"
    class="listing" border="0"
    cellspacing="0" cellpadding="0">
    <tr>
      <th>
        &nbsp;
      </th>
      <th>
        &nbsp;
      </th>
      <th i18n:translate="label_identite">
        Identite
      </th>
      <th i18n:translate="label_delegation_date">
	Delegation Date
      </th>
      <th i18n:translate="label_directive">
        Directive
      </th>
      <th i18n:translate="label_directive_comment">
        Comment
      </th>
      <th>
        &nbsp;
      </th>
    </tr>
    <tal:block repeat="level levels">
      <tal:block define="level_infos python:infos[level];
                         level_items python:level_infos['items'];
                        ">
        <tr tal:repeat="content level_items"
	    tal:attributes="class python:test(repeat['level'].odd(),
			    'odd', 'even')">
	  <td> 
            <input type="checkbox" name="pop_ids:list"
              tal:condition="not:content/not_deletable|nothing"
              tal:attributes="value content/input_id;
                              id content/label_id;
                             " />
	  </td>
          <td>
            <tal:block  condition="level_infos/current_level"
	      replace="structure python:here.getImgTag(
	                             'stack_current_level.png',
				     base_url=portal_url,
				     alt='Niveau courant')" />
          </td>
          <td>
            <tal:block content="content/identite">
              Delegatee
            </tal:block>
            &nbsp;
          </td>
          <td>
            <tal:block content="content/delegation_date_str|string:">
              Delegation date
            </tal:block>
            &nbsp;
          </td>
          <td>
            <tal:block define="voc_key content/directive|string:"
              content="python:vocabulary.get(voc_key, voc_key) or ' '">
              Directive
            </tal:block>
            &nbsp;
            <div class="field"
              tal:define="directive content/directive|string:">
              <select name="directives:list"
		      tal:define="list python:[(voc[1].strip(), voc) for voc in vocabulary.items()];
				  sort_list python:list.sort();
				  vocabulary_list python:[item[1] for item in list];
				  ">
                <tal:block repeat="item vocabulary_list">
                  <option
                    tal:define="k python:item[0];
                                w python:item[1];"
                    tal:content="w"
                    tal:attributes="value k;
                                    selected python:directive == k;" />
                </tal:block>
                <option
                  tal:condition="python:directive not in vocabulary.keys()"
                  tal:content="directive"
                  tal:attributes="value directive"
                  selected="selected" />
              </select>
            </div>
          </td>
          <td>
            <tal:block content="content/comment|string:">
              Comment
            </tal:block>
            &nbsp;
          </td>
        </tr>
      </tal:block>
    </tal:block>
  </table>
</tal:block>

<tal:block condition="python:mode=='edit'">
  <table summary="stack content for edit"
    class="Docs" border="0"
    cellspacing="0" cellpadding="0">
    <tr>
      <th>
        &nbsp;
      </th>
      <th>
        &nbsp;
      </th>
      <th i18n:translate="label_identite">
        Identite
      </th>
      <th i18n:translate="label_delegation_date">
        Delegation Date
      </th>
      <th i18n:translate="label_directive">
        Directive
      </th>
      <th i18n:translate="label_directive_comment">
        Comment
      </th>
    </tr>
    <tal:block define="
      list python:[(voc[1].strip(), voc) for voc in vocabulary.items()];
      sort_list python:list.sort();
      vocabulary_list python:[item[1] for item in list];
     ">
    <tal:block repeat="level levels">
      <tal:block define="level_infos python:infos[level];
                         level_items python:level_infos['items'];
                        ">
        <tr tal:repeat="content level_items"
            tal:attributes="class python:test(repeat['level'].even(), 'Paire', nothing)">
          <td class="Checkbox">
            <input type="checkbox" name="pop_ids:list"
              tal:condition="content/deletable"
              tal:attributes="value content/input_id;
                              id content/label_id;
                             " />
            <input type="hidden" name="edit_ids:list"
              tal:attributes="value content/input_id" />
          </td>
          <td tal:condition="level_infos/current_level">
            <tal:block replace="structure python:here.getImgTag(
                                'arrow_pagination_right_off.gif',
                                base_url=portal_url,
                                alt='Niveau courant')" />
          </td>
          <td tal:condition="not:level_infos/current_level">
            &nbsp;
          </td>
          <td>
            <label tal:content="content/identite"
                   tal:attributes="for content/label_id">
              Delegatee
            </label>
            &nbsp;
          </td>
          <td>
            <div class="field"
              tal:define="directive content/directive|string:">
              <select name="directives:list">
                <tal:block repeat="item vocabulary_list">
                  <option
                    tal:define="k python:item[0];
                                w python:item[1];"
                    tal:content="w"
                    tal:attributes="value k;
                                    selected python:directive == k;" />
                </tal:block>
                <option
                  tal:condition="python:directive not in vocabulary.keys()"
                  tal:content="directive"
                  tal:attributes="value directive"
                  selected="selected" />
              </select>
            </div>
          </td>
          <td>
            <div class="field"
              tal:define="comment content/comment|string:">
              <input name="comments:list" type="text"
                tal:attributes="value comment" size="30" />
            </div>
          </td>
        </tr>
      </tal:block>
    </tal:block>
    </tal:block>
  </table>
</tal:block>


<tal:block condition="python:mode=='insert'">
  <table summary="stack content for insert"
    class="Docs" border="0"
    cellspacing="0" cellpadding="0">
    <tr>
      <th>
        &nbsp;
      </th>
      <th>
        &nbsp;
      </th>
      <th i18n:translate="label_identite">
        Identite
      </th>
      <th i18n:translate="label_action_state">
        State
      </th>
      <th i18n:translate="label_acknowledge_date">
        Acknowledge Date
      </th>
      <th i18n:translate="label_delegation_date">
        Delegatiom Date
      </th>
      <th i18n:translate="label_directive">
        Directive
      </th>
      <th i18n:translate="label_directive_comment">
        Comment
      </th>
    </tr>
    <tal:block repeat="level levels">
    <tal:block define="level_infos python:infos[level];
                       level_items python:level_infos['items'];
                      ">
      <tr tal:condition="not:level_items"
        tal:attributes="class python:test(repeat['level'].even(), 'Paire', nothing)">
        <td class="Checkbox">
          <input type="radio" name="level" value="---"
                 tal:attributes="value level;
                                 id level_infos/label_level;
                                " />
        </td>
        <td colspan="8">
          <label tal:attributes="for level_infos/label_level">
            ---------
          </label>
        </td>
      </tr>
      <tal:block condition="level_items">
        <tr tal:repeat="content level_items"
          tal:attributes="class python:test(repeat['level'].even(), 'Paire', nothing)">
          <td tal:condition="repeat/content/start"
              tal:attributes="rowspan python:len(level_items)">
            <input type="radio" name="level" value="---"
                   tal:condition="level_infos/insertable"
                   tal:attributes="value level;
                                   id level_infos/label_level;
                                  " />
          </td>
          <td tal:condition="level_infos/current_level">
            <tal:block replace="structure python:here.getImgTag(
                                'arrow_pagination_right_off.gif',
                                base_url=portal_url,
                                alt='Niveau courant')" />
          </td>
          <td tal:condition="not:level_infos/current_level">
            &nbsp;
          </td>
          <td>
            <label tal:content="content/identite"
                   tal:attributes="for level_infos/label_level">
              Delegatee
            </label>
            &nbsp;
          </td>
        </tr>
      </tal:block>
    </tal:block>
    </tal:block>
  </table>
</tal:block>

</tal:block>
