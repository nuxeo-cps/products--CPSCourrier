<table summary="stack content"
       class="listing" border="0"
       cellspacing="0" cellpadding="0"
       tal:define="
		   stack_context nocall:options/context;
		   stack options/stack;
		   mode options/mode;
		   insert_mode python:mode == 'insert';
		   edit_mode python:mode == 'edit';
		   stack_infos python:stack.getStackContentForRender(context, mode);
		   levels python:stack_infos[0];
		   infos python:stack_infos[1];
		   vtool stack_context/portal_vocabularies;
		   vocabulary python:getattr(vtool, 'mail_directives', {});
		   utool nocall:here/portal_url;
		   portal portal|here/portal_url/getPortalObject;
		   portal_url python:portal.absolute_url()+'/';">
  <tr>
    <th>
      &nbsp;
    </th>
    <th tal:condition="python:mode != 'view'">
      &nbsp;
    </th>
    <th i18n:translate="label_identite">
      Identite
    </th>
    <th i18n:translate="label_delegation_date">
      Delegation Date
    </th>
    <th i18n:translate="label_directive">
      Directive
    </th>
    <th i18n:translate="label_directive_comment">
      Comment
    </th>
    <th>
      &nbsp;
    </th>
  </tr>
  <tal:levels repeat="level levels">
    <tal:block define="level_infos python:infos[level];
		       level_items python:level_infos['items'] or insert_mode and [{}];
		       level_class python:test(repeat['level'].odd(),
		                               'odd', 'even')">

      <tal:block repeat="content level_items">
	<tr tal:attributes="class level_class">
	  <td tal:attributes="rowspan repeat/content/length"
	      tal:condition="repeat/content/start">

	    <tal:block condition="level_infos/current_level"
		       replace="structure python:here.getImgTag(
				'stack_current_level.png',
				base_url=portal_url,
				alt='Niveau courant')" />
	  </td>
	  <td tal:condition="python:insert_mode and repeat['content'].start"
	      tal:attributes = "rowspan repeat/content/length">
	    <input type="radio" name="level" value="level"
		   tal:attributes="value level_infos/level_str" />
	  </td>
	  <td tal:condition="edit_mode">
	    <input type="checkbox" name="pop_ids:list"
		   tal:condition="content/deletable"
		   tal:attributes="value content/input_id;
				   id content/label_id"
		   />
	  </td>
      <input type="hidden" name="edit_ids:list"
	     tal:condition="content"
	     tal:attributes="value content/input_id;
			     id content/label_id;"
	     />
      <td>
	  <tal:block content="content/identite|string:">
	    Delegatee
	  </tal:block>
	  &nbsp;
      </td>
      <td tal:content="content/delegation_date_str|string:">
	Delegation date
      </td>
      <td>
	<tal:block define="voc_key content/directive|string:;
			   editable python:edit_mode and content['editable']">
	  <tal:render condition="not:editable"
		      content="python:vocabulary.get(voc_key, voc_key) or ' '">
	    Directive
	    </tal:render>
	    <tal:render condition="editable">
	      <select name="directive:list"
		      tal:define="list python:[(voc[1].strip(), voc) for voc in vocabulary.items()];
				  sort_list python:list.sort();
				  vocabulary_list python:[item[1] for item in list];
				  ">
		<tal:block repeat="item vocabulary_list">
		  <option
		      tal:define="k python:item[0];
				  w python:item[1];"
		      tal:content="w"
		      tal:attributes="value k;
				      selected python:voc_key == k;" />
		</tal:block>
		<option
		    tal:condition="python:voc_key not in vocabulary.keys()"
		    tal:content="voc_key"
		    tal:attributes="value voc_key"
		    selected="selected" />
	      </select>
	    </tal:render>
	  </tal:block>
      </td>
      <td>
	  <tal:block content="content/comment|string:">
	    Comment
	  </tal:block>
	  &nbsp;
      </td>
     </tr>
    </tal:block>
    </tal:block>
  </tal:levels>
</table>

